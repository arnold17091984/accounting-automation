{
  "name": "03 - Budget Variance Monitor v2",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [{ "field": "cronExpression", "expression": "0 18 * * *" }]
        }
      },
      "id": "daily-trigger",
      "name": "Daily 6PM Check",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [100, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  b.entity,\n  b.account_code,\n  b.account_name,\n  b.category,\n  b.budget_amount,\n  COALESCE(SUM(t.amount), 0) as actual_amount,\n  ROUND((COALESCE(SUM(t.amount), 0) / NULLIF(b.budget_amount, 0)) * 100, 1) as usage_pct\nFROM budgets b\nLEFT JOIN transactions t ON \n  t.entity = b.entity AND \n  t.account_code = b.account_code AND\n  EXTRACT(YEAR FROM t.txn_date) = b.year AND\n  EXTRACT(MONTH FROM t.txn_date) = b.month\nWHERE b.year = EXTRACT(YEAR FROM CURRENT_DATE)\n  AND b.month = EXTRACT(MONTH FROM CURRENT_DATE)\nGROUP BY b.id, b.entity, b.account_code, b.account_name, b.category, b.budget_amount\nHAVING COALESCE(SUM(t.amount), 0) / NULLIF(b.budget_amount, 0) >= 0.7\nORDER BY usage_pct DESC",
        "options": {}
      },
      "id": "check-budgets",
      "name": "Check Budget Usage",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [300, 300]
    },
    {
      "parameters": {
        "jsCode": "// Format budget alerts\nconst items = $input.all();\n\nif (items.length === 0) {\n  return [{ json: { hasAlerts: false, message: 'No budget alerts today.' } }];\n}\n\nlet report = 'âš ï¸ *Budget Alert Report*\\n';\nreport += `Date: ${new Date().toISOString().split('T')[0]}\\n`;\nreport += '\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n';\n\nconst critical = items.filter(i => parseFloat(i.json.usage_pct) >= 100);\nconst warning = items.filter(i => parseFloat(i.json.usage_pct) >= 90 && parseFloat(i.json.usage_pct) < 100);\nconst caution = items.filter(i => parseFloat(i.json.usage_pct) >= 70 && parseFloat(i.json.usage_pct) < 90);\n\nif (critical.length > 0) {\n  report += '\\nğŸ”´ *OVER BUDGET*\\n';\n  for (const item of critical) {\n    const d = item.json;\n    report += `â€¢ ${d.entity} - ${d.account_name}\\n`;\n    report += `  Budget: â‚±${parseInt(d.budget_amount).toLocaleString()} | Actual: â‚±${parseInt(d.actual_amount).toLocaleString()} (${d.usage_pct}%)\\n`;\n  }\n}\n\nif (warning.length > 0) {\n  report += '\\nğŸŸ¡ *90%+ USAGE*\\n';\n  for (const item of warning) {\n    const d = item.json;\n    report += `â€¢ ${d.entity} - ${d.account_name}: ${d.usage_pct}%\\n`;\n  }\n}\n\nif (caution.length > 0) {\n  report += '\\nğŸŸ  *70%+ USAGE*\\n';\n  for (const item of caution) {\n    const d = item.json;\n    report += `â€¢ ${d.entity} - ${d.account_name}: ${d.usage_pct}%\\n`;\n  }\n}\n\nreport += '\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”';\nreport += `\\nTotal alerts: ${items.length}`;\n\nreturn [{ json: { hasAlerts: true, message: report, alertCount: items.length } }];"
      },
      "id": "format-alerts",
      "name": "Format Alerts",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [500, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" },
          "conditions": [{ "leftValue": "={{ $json.hasAlerts }}", "rightValue": true, "operator": { "type": "boolean", "operation": "equals" } }],
          "combinator": "and"
        }
      },
      "id": "if-alerts",
      "name": "Has Alerts?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [700, 300]
    },
    {
      "parameters": {
        "operation": "sendMessage",
        "chatId": "-5195093277",
        "text": "={{ $json.message }}",
        "additionalFields": { "parse_mode": "Markdown" }
      },
      "id": "send-alert",
      "name": "Send Alert",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [900, 200]
    }
  ],
  "connections": {
    "Daily 6PM Check": { "main": [[{ "node": "Check Budget Usage", "type": "main", "index": 0 }]] },
    "Check Budget Usage": { "main": [[{ "node": "Format Alerts", "type": "main", "index": 0 }]] },
    "Format Alerts": { "main": [[{ "node": "Has Alerts?", "type": "main", "index": 0 }]] },
    "Has Alerts?": { "main": [[{ "node": "Send Alert", "type": "main", "index": 0 }], []] }
  },
  "settings": { "executionOrder": "v1" },
  "tags": ["budget", "alert", "daily"]
}
